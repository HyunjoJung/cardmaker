@page "/"
@using BusinessCardMaker.Core.Models
@using BusinessCardMaker.Core.Services.Import
@using BusinessCardMaker.Core.Services.CardGenerator
@using BusinessCardMaker.Core.Services.Template
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using System
@inject IExcelImportService ImportService
@inject ICardGeneratorService CardService
@inject ITemplateService TemplateService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>CardMaker</PageTitle>

<div class="container py-5">
    <div class="text-center mb-5">
        <img src="images/hero.png" alt="CardMaker" class="img-fluid mb-4" style="max-width: 500px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" />
        <h1 class="display-4 fw-bold text-primary">CardMaker</h1>
        <p class="lead text-muted">Automatically generate business cards with QR codes from Excel files</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3 text-muted">@processingMessage</p>
            @if (progress > 0)
            {
                <div class="progress" style="height: 30px; max-width: 500px; margin: 0 auto;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: @(progress)%">@progress%</div>
                </div>
            }
        </div>
    }
    else if (generationResult != null && generationResult.Success)
    {
        <div class="card border-success shadow-sm">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">âœ“ Cards Generated Successfully!</h4>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <h5 class="text-success">@generationResult.SuccessCount</h5>
                        <small class="text-muted">Success</small>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-danger">@generationResult.FailedCount</h5>
                        <small class="text-muted">Failed</small>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-primary">@(generationResult.SuccessCount + generationResult.FailedCount)</h5>
                        <small class="text-muted">Total</small>
                    </div>
                </div>

                @if (generationResult.Errors.Any())
                {
                    <div class="alert alert-warning">
                        <h6>Errors (@generationResult.Errors.Count):</h6>
                        <ul class="mb-0">
                            @foreach (var error in generationResult.Errors.Take(5))
                            {
                                <li><small>@error</small></li>
                            }
                            @if (generationResult.Errors.Count > 5)
                            {
                                <li><small><em>... and @(generationResult.Errors.Count - 5) more</em></small></li>
                            }
                        </ul>
                    </div>
                }

                <div class="d-grid gap-3">
                    <button class="btn btn-success btn-lg" @onclick="DownloadZip">
                        <i class="bi bi-download"></i> Download Cards (.zip)
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="Reset">
                        <i class="bi bi-arrow-counterclockwise"></i> Start New
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Step 1: Download Templates -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Step 1. Download Templates</h4>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">Download Excel and PowerPoint templates to get started</p>
                <div class="row g-3">
                    <div class="col-md-6">
                        @if (isInteractive)
                        {
                            <button class="btn btn-outline-primary w-100 py-3" @onclick="DownloadExcelTemplate">
                                <i class="bi bi-file-earmark-excel"></i><br />
                                <strong>Download Excel Template</strong><br />
                                <small>Employee data format</small>
                            </button>
                        }
                    </div>
                    <div class="col-md-6">
                        @if (isInteractive)
                        {
                            <div class="dropdown">
                                <button class="btn btn-outline-success w-100 py-3 dropdown-toggle"
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-file-earmark-ppt"></i><br />
                                    <strong>Download PowerPoint Template</strong><br />
                                    <small>Business card design</small>
                                </button>
                                <ul class="dropdown-menu w-100">
                                    <li><button class="dropdown-item" @onclick="() => DownloadPPTTemplate(false)">
                                        Basic Template (No QR)</button></li>
                                    <li><button class="dropdown-item" @onclick="() => DownloadPPTTemplate(true)">
                                        QR Code Template</button></li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Upload & Generate -->
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Step 2. Upload Files & Generate Cards</h4>
            </div>
            <div class="card-body">
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-earmark-excel text-primary"></i> Excel File
                        </label>
                        @if (isInteractive)
                        {
                            <InputFile class="form-control" id="excelInput" accept=".xlsx,.xls"
                                       OnChange="HandleExcelSelected" />
                        }
                        <small class="text-muted">Max 10MB</small>
                        @if (importResult != null && importResult.Success)
                        {
                            <div class="alert alert-success mt-2 mb-0">
                                <i class="bi bi-check-circle"></i> Loaded @importResult.TotalCount employee(s)
                            </div>
                        }
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-earmark-ppt text-success"></i> PowerPoint Template
                        </label>
                        @if (isInteractive)
                        {
                            <InputFile class="form-control" id="templateInput" accept=".pptx"
                                       OnChange="HandleTemplateSelected" />
                        }
                        <small class="text-muted">Max 50MB</small>
                        @if (templateFile != null)
                        {
                            <div class="alert alert-info mt-2 mb-0">
                                <i class="bi bi-check-circle"></i> Template: @templateFile.Name
                            </div>
                        }
                    </div>
                </div>

                <div class="d-flex gap-3 flex-wrap">
                    <button class="btn btn-outline-primary btn-lg"
                            disabled="@(excelFile == null || !isInteractive)"
                            @onclick="ImportExcel">
                        <i class="bi bi-upload"></i> Upload Excel
                    </button>
                    <button class="btn btn-success btn-lg"
                            disabled="@(excelFile == null || templateFile == null || !isInteractive || importResult?.Success != true)"
                            @onclick="GenerateCards">
                        <i class="bi bi-gear"></i> Generate Cards
                    </button>
                </div>

                @if (excelFile == null || templateFile == null)
                {
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        Please upload both Excel and PowerPoint files
                    </div>
                }
            </div>
        </div>

        <!-- How to Use -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">How to Use</h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>Download Excel and PowerPoint templates in Step 1</li>
                    <li>Fill employee information in Excel (Name and Email required)</li>
                    <li>Customize PowerPoint template with placeholders:
                        <code>{name}</code>, <code>{position}</code>, <code>{email}</code>,
                        <code>{mobile}</code>, <code>{qrcode}</code>, etc.
                    </li>
                    <li>Upload both files in Step 2 and click 'Generate'</li>
                    <li>Download the generated business cards (.zip)</li>
                </ol>
            </div>
        </div>
    }
</div>

@code {
    private bool isInteractive = false;
    private bool isProcessing = false;
    private int progress = 0;
    private string processingMessage = "";
    private string? errorMessage;

    private IBrowserFile? excelFile;
    private IBrowserFile? templateFile;
    private ImportResult? importResult;
    private CardGenerationResult? generationResult;
    private readonly bool isE2ETestMode = string.Equals(Environment.GetEnvironmentVariable("E2E_FAKE_IMPORT"), "true", StringComparison.OrdinalIgnoreCase);

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isInteractive = true;
            StateHasChanged();
        }
    }

    private async Task HandleExcelSelected(InputFileChangeEventArgs e)
    {
        excelFile = e.File;
        importResult = null;
        errorMessage = null;
    }

    private void HandleTemplateSelected(InputFileChangeEventArgs e)
    {
        templateFile = e.File;
        errorMessage = null;
    }

    private async Task DownloadExcelTemplate()
    {
        try
        {
            var bytes = ImportService.CreateTemplate();
            var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream: stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", "employee_template.xlsx", streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = $"Template download failed: {ex.Message}";
        }
    }

    private async Task DownloadPPTTemplate(bool withQRCode)
    {
        try
        {
            var bytes = withQRCode ? TemplateService.CreateQRCodeTemplate() : TemplateService.CreateBasicTemplate();
            var filename = withQRCode ? "BusinessCard_QRCode_Template.pptx" : "BusinessCard_Basic_Template.pptx";
            var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream: stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", filename, streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = $"Template download failed: {ex.Message}";
        }
    }

    private async Task ImportExcel()
    {
        if (excelFile == null) return;

        try
        {
            isProcessing = true;
            progress = 0;
            processingMessage = "Analyzing Excel file...";
            errorMessage = null;
            StateHasChanged();

            var progressReporter = new Progress<int>(value =>
            {
                progress = value;
                InvokeAsync(StateHasChanged);
            });

            // E2E test mode: skip JS file handle to avoid flaky browser uploads
            if (isE2ETestMode)
            {
                var isExcel = excelFile.Name.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase) ||
                              excelFile.Name.EndsWith(".xls", StringComparison.OrdinalIgnoreCase);

                if (isExcel)
                {
                    importResult = ImportResult.CreateSuccess(new List<Employee>
                    {
                        new() { Name = "Test User", Email = "test@example.com", Company = "TestCo" }
                    });
                }
                else
                {
                    importResult = ImportResult.CreateFailure("Invalid Excel file (test mode)");
                    errorMessage = importResult.ErrorMessage;
                }
            }
            else
            {
                using var stream = new MemoryStream();
                await excelFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
                stream.Position = 0;
                importResult = await ImportService.ImportFromExcelAsync(stream, progressReporter);
            }

            if (!importResult.Success)
            {
                errorMessage = importResult.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Excel import failed: {ex.Message}";
            importResult = null;
        }
        finally
        {
            isProcessing = false;
            progress = 0;
            StateHasChanged();
        }
    }

    private async Task GenerateCards()
    {
        if (templateFile == null || importResult?.Success != true)
        {
            errorMessage = "Please upload both Excel and PowerPoint files.";
            return;
        }

        try
        {
            isProcessing = true;
            progress = 0;
            processingMessage = $"Generating {importResult.Employees.Count} business card(s) with QR codes...";
            errorMessage = null;
            StateHasChanged();

            var progressReporter = new Progress<int>(value =>
            {
                progress = value;
                InvokeAsync(StateHasChanged);
            });

            using var stream = templateFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            generationResult = await CardService.GenerateBatchAsync(importResult.Employees, stream, progressReporter);

            if (!generationResult.Success)
            {
                errorMessage = generationResult.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Business card generation failed: {ex.Message}";
            generationResult = null;
        }
        finally
        {
            isProcessing = false;
            progress = 0;
            processingMessage = "";
        }
    }

    private async Task DownloadZip()
    {
        if (generationResult?.ZipFilePath == null || !File.Exists(generationResult.ZipFilePath))
        {
            errorMessage = "Download file not found.";
            return;
        }

        try
        {
            var bytes = await File.ReadAllBytesAsync(generationResult.ZipFilePath);
            var fileName = Path.GetFileName(generationResult.ZipFilePath);
            var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream: stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = $"Download failed: {ex.Message}";
        }
    }

    private void Reset()
    {
        excelFile = null;
        templateFile = null;
        importResult = null;
        generationResult = null;
        errorMessage = null;
        progress = 0;
    }
}
