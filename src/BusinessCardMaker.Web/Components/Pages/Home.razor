@page "/"
@using BusinessCardMaker.Core.Models
@using BusinessCardMaker.Core.Services.Import
@using BusinessCardMaker.Core.Services.CardGenerator
@using BusinessCardMaker.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Hosting
@using System
@inject IExcelImportService ImportService
@inject ICardGeneratorService CardService
@inject IJSRuntime JS
@inject IWebHostEnvironment WebHostEnvironment
@rendermode InteractiveServer

<PageTitle>CardMaker - Business Card Generator with QR Codes</PageTitle>

<HeadContent>
    <meta name="description" content="Generate business cards with QR codes from Excel data. Upload your Excel file and PowerPoint template to create professional business cards instantly. No registration required." />
    <link rel="canonical" href="https://cardmaker.hyunjo.uk/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://cardmaker.hyunjo.uk/" />
    <meta property="og:title" content="CardMaker - Business Card Generator with QR Codes" />
    <meta property="og:description" content="Generate business cards with QR codes from Excel data. Upload your Excel file and PowerPoint template to create professional business cards instantly. No registration required." />
    <meta property="og:image" content="https://cardmaker.hyunjo.uk/images/og-image.png" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://cardmaker.hyunjo.uk/" />
    <meta property="twitter:title" content="CardMaker - Business Card Generator with QR Codes" />
    <meta property="twitter:description" content="Generate business cards with QR codes from Excel data. Upload your Excel file and PowerPoint template to create professional business cards instantly. No registration required." />
    <meta property="twitter:image" content="https://cardmaker.hyunjo.uk/images/og-image.png" />
</HeadContent>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">CardMaker</h1>
        <p class="lead text-muted">Automatically generate business cards with QR codes from Excel files</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3 text-muted">@processingMessage</p>
            @if (progress > 0)
            {
                <div class="progress" style="height: 30px; max-width: 500px; margin: 0 auto;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: @(progress)%">@progress%</div>
                </div>
            }
        </div>
    }
    else if (generationResult != null && generationResult.Success)
    {
        <div class="card border-success shadow-sm">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">âœ“ Cards Generated Successfully!</h4>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <h5 class="text-success">@generationResult.SuccessCount</h5>
                        <small class="text-muted">Success</small>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-danger">@generationResult.FailedCount</h5>
                        <small class="text-muted">Failed</small>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-primary">@(generationResult.SuccessCount + generationResult.FailedCount)</h5>
                        <small class="text-muted">Total</small>
                    </div>
                </div>

                @if (generationResult.Errors.Any())
                {
                    <div class="alert alert-warning">
                        <h6>Errors (@generationResult.Errors.Count):</h6>
                        <ul class="mb-0">
                            @foreach (var error in generationResult.Errors.Take(5))
                            {
                                <li><small>@error</small></li>
                            }
                            @if (generationResult.Errors.Count > 5)
                            {
                                <li><small><em>... and @(generationResult.Errors.Count - 5) more</em></small></li>
                            }
                        </ul>
                    </div>
                }

                <div class="d-grid gap-3">
                    <button class="btn btn-success btn-lg" @onclick="DownloadZip">
                        <i class="bi bi-download"></i> Download Cards (.zip)
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="Reset">
                        <i class="bi bi-arrow-counterclockwise"></i> Start New
                    </button>
                </div>

                <SupportFooter />
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-4">
            <!-- Step 1: Download Templates -->
            <div class="col-lg-4">
                <div class="step-card h-100">
                    <div class="step-header bg-primary text-white">
                        <strong>Step 1. Download Templates</strong>
                    </div>
                    <div class="step-body">
                        <p class="text-muted mb-4">Sample files to start</p>
                        <div class="d-grid gap-3">
                            <button class="btn btn-outline-primary py-2 @(isExcelTemplateDownloading ? "skeleton-button" : "")"
                                    disabled="@(!isInteractive || isExcelTemplateDownloading)"
                                    @onclick="DownloadExcelTemplate">
                                <i class="bi bi-file-earmark-excel"></i> Excel Template
                            </button>
                            <button class="btn btn-outline-success py-2 @(isTemplateDownloading ? "skeleton-button" : "")"
                                    disabled="@(!isInteractive || isTemplateDownloading)"
                                    @onclick="DownloadPPTTemplate">
                                <i class="bi bi-file-earmark-ppt"></i> PPT Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Upload Excel -->
            <div class="col-lg-4">
                <div class="step-card h-100">
                    <div class="step-header bg-info text-white">
                        <strong>Step 2. Upload Excel</strong>
                    </div>
                    <div class="step-body text-center">
                        <p class="text-muted mb-4">Upload employee data</p>
                        @if (isInteractive)
                        {
                            <label for="excelInput" class="visually-hidden">Select Excel file</label>
                            <InputFile class="form-control" id="excelInput" accept=".xlsx,.xls"
                                       style="max-width: 300px; margin: 0 auto;"
                                       OnChange="HandleExcelSelected" />
                            <button class="btn btn-primary btn-lg mt-3 @(isProcessing ? "skeleton-button" : "")"
                                    disabled="@(excelFile == null || !isInteractive || isProcessing)"
                                    @onclick="ImportExcel">
                                <i class="bi bi-upload"></i> Upload & Process
                            </button>
                            <p class="mt-2 small text-muted">Max 10MB</p>
                        }
                        else
                        {
                            <div class="skeleton skeleton-input" style="max-width: 300px; margin: 0 auto;"></div>
                            <div class="skeleton skeleton-button mt-3"></div>
                            <div class="skeleton skeleton-text mt-2" style="max-width: 80px; margin: 0 auto;"></div>
                        }
                        @if (importResult != null && importResult.Success)
                        {
                            <div class="alert alert-success mt-3 mb-0 small">
                                <i class="bi bi-check-circle"></i> Loaded @importResult.TotalCount employee(s)
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Step 3: Upload PPT & Generate -->
            <div class="col-lg-4">
                <div class="step-card h-100">
                    <div class="step-header bg-success text-white">
                        <strong>Step 3. Generate Cards</strong>
                    </div>
                    <div class="step-body text-center">
                        <p class="text-muted mb-4">Upload PPT & generate</p>
                        @if (isInteractive)
                        {
                            <label for="templateInput" class="visually-hidden">Select PowerPoint template</label>
                            <InputFile class="form-control" id="templateInput" accept=".pptx"
                                       style="max-width: 300px; margin: 0 auto;"
                                       disabled="@(importResult?.Success != true)"
                                       OnChange="HandleTemplateSelected" />
                            <button class="btn btn-success btn-lg mt-3 @(isProcessing ? "skeleton-button" : "")"
                                    disabled="@(importResult?.Success != true || templateFile == null || isProcessing)"
                                    @onclick="GenerateCards">
                                <i class="bi bi-gear"></i> Generate Cards
                            </button>
                            <p class="mt-2 small text-muted">Max 50MB</p>
                            @if (templateFile != null)
                            {
                                <div class="alert alert-info mt-3 mb-0 small">
                                    <i class="bi bi-check-circle"></i> @templateFile.Name
                                </div>
                            }
                        }
                        else
                        {
                            <div class="skeleton skeleton-input" style="max-width: 300px; margin: 0 auto;"></div>
                            <div class="skeleton skeleton-button mt-3"></div>
                            <div class="skeleton skeleton-text mt-2" style="max-width: 80px; margin: 0 auto;"></div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- How to Use -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">How to Use</h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>Download Excel and PowerPoint templates from Step 1</li>
                    <li>Fill employee data in Excel (Name and Email required)</li>
                    <li>Customize PowerPoint template with placeholders:
                        <code>{name}</code>, <code>{position}</code>, <code>{email}</code>,
                        <code>{mobile}</code>, <code>{qrcode}</code>
                    </li>
                    <li>Upload and process Excel file in Step 2</li>
                    <li>Upload PowerPoint template in Step 3 and generate cards</li>
                    <li>Download the generated business cards (.zip)</li>
                </ol>
            </div>
        </div>
    }
</div>

@code {
    private bool isInteractive = false;
    private bool isProcessing = false;
    private bool isExcelTemplateDownloading = false;
    private bool isTemplateDownloading = false;
    private int progress = 0;
    private string processingMessage = "";
    private string? errorMessage;

    private IBrowserFile? excelFile;
    private IBrowserFile? templateFile;
    private ImportResult? importResult;
    private CardGenerationResult? generationResult;
    private readonly bool isE2ETestMode = string.Equals(Environment.GetEnvironmentVariable("E2E_FAKE_IMPORT"), "true", StringComparison.OrdinalIgnoreCase);

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isInteractive = true;
            StateHasChanged();
        }
    }

    private async Task HandleExcelSelected(InputFileChangeEventArgs e)
    {
        excelFile = e.File;
        importResult = null;
        errorMessage = null;
    }

    private void HandleTemplateSelected(InputFileChangeEventArgs e)
    {
        templateFile = e.File;
        errorMessage = null;
    }

    private async Task DownloadExcelTemplate()
    {
        if (isExcelTemplateDownloading) return;

        try
        {
            isExcelTemplateDownloading = true;
            errorMessage = null;
            StateHasChanged();

            var bytes = ImportService.CreateTemplate();
            var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream: stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", "employee_template.xlsx", streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = $"Template download failed: {ex.Message}";
        }
        finally
        {
            isExcelTemplateDownloading = false;
            StateHasChanged();
        }
    }

    private async Task DownloadPPTTemplate()
    {
        if (isTemplateDownloading) return;

        try
        {
            isTemplateDownloading = true;
            errorMessage = null;
            StateHasChanged();

            var templatePath = Path.Combine(WebHostEnvironment.WebRootPath, "templates", "CardMaker_Template.pptx");
            var bytes = await File.ReadAllBytesAsync(templatePath);
            var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream: stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", "CardMaker_Template.pptx", streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = $"Template download failed: {ex.Message}";
        }
        finally
        {
            isTemplateDownloading = false;
            StateHasChanged();
        }
    }

    private async Task ImportExcel()
    {
        if (excelFile == null) return;

        try
        {
            isProcessing = true;
            progress = 0;
            processingMessage = "Analyzing Excel file...";
            errorMessage = null;
            StateHasChanged();

            var progressReporter = new Progress<int>(value =>
            {
                progress = value;
                InvokeAsync(StateHasChanged);
            });

            // E2E test mode: skip JS file handle to avoid flaky browser uploads
            if (isE2ETestMode)
            {
                var isExcel = excelFile.Name.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase) ||
                              excelFile.Name.EndsWith(".xls", StringComparison.OrdinalIgnoreCase);

                if (isExcel)
                {
                    importResult = ImportResult.CreateSuccess(new List<Employee>
                    {
                        new() { Name = "Test User", Email = "test@example.com", Company = "TestCo" }
                    });
                }
                else
                {
                    importResult = ImportResult.CreateFailure("Invalid Excel file (test mode)");
                    errorMessage = importResult.ErrorMessage;
                }
            }
            else
            {
                using var stream = new MemoryStream();
                await excelFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
                stream.Position = 0;
                importResult = await ImportService.ImportFromExcelAsync(stream, progressReporter);
            }

            if (!importResult.Success)
            {
                errorMessage = importResult.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Excel import failed: {ex.Message}";
            importResult = null;
        }
        finally
        {
            isProcessing = false;
            progress = 0;
            StateHasChanged();
        }
    }

    private async Task GenerateCards()
    {
        if (templateFile == null || importResult?.Success != true)
        {
            errorMessage = "Please upload both Excel and PowerPoint files.";
            return;
        }

        try
        {
            isProcessing = true;
            progress = 0;
            processingMessage = $"Generating {importResult.Employees.Count} business card(s) with QR codes...";
            errorMessage = null;
            StateHasChanged();

            var progressReporter = new Progress<int>(value =>
            {
                progress = value;
                InvokeAsync(StateHasChanged);
            });

            using var stream = templateFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            generationResult = await CardService.GenerateBatchAsync(importResult.Employees, stream, progressReporter);

            if (!generationResult.Success)
            {
                errorMessage = generationResult.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Business card generation failed: {ex.Message}";
            generationResult = null;
        }
        finally
        {
            isProcessing = false;
            progress = 0;
            processingMessage = "";
        }
    }

    private async Task DownloadZip()
    {
        if (generationResult?.ZipFilePath == null || !File.Exists(generationResult.ZipFilePath))
        {
            errorMessage = "Download file not found.";
            return;
        }

        try
        {
            var bytes = await File.ReadAllBytesAsync(generationResult.ZipFilePath);
            var fileName = Path.GetFileName(generationResult.ZipFilePath);
            var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream: stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = $"Download failed: {ex.Message}";
        }
    }

    private void Reset()
    {
        excelFile = null;
        templateFile = null;
        importResult = null;
        generationResult = null;
        errorMessage = null;
        progress = 0;
    }
}
